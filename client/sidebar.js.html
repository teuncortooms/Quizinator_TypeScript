<script>
    /**
     * Use this for logging
     */
    function logHTML(array) {
        //  let array = ["test", units, units.length];
        let t;
        for (t = 0; t < array.length; t++) {
            let testPara = document.createElement('P');
            let testText = document.createTextNode(array[t]);
            testPara.appendChild(testText);
            document.body.appendChild(testPara);
        }
    }


    /**
     * Return a formatted date (for use in sidebar)
     */

    // Helper function
    function addZero(i) {
        if (i < 10) {
            i = "0" + i;
        }
        return i;
    }

    // Return a formatted date
    function getDateAndTime() {
        let d = new Date();
        let year = String(d.getFullYear());
        let month = String(addZero(d.getMonth() + 1));
        let day = String(addZero(d.getDate()));
        let h = String(addZero(d.getHours()));
        let m = String(addZero(d.getMinutes()));
        let s = String(addZero(d.getSeconds()));
        let fullDateAndTime = year + month + day + ' ' + h + ":" + m + ":" + s;
        return fullDateAndTime;
    }


    /**
     * Functions to load form
     */
    function loadForm() {
        google.script.run
            .withSuccessHandler(buildForm)
            .sidebar_loadUnits();
    }

    function createExample() {
        google.script.run
            .withSuccessHandler(buildForm)
            .button_createExample_click();
    }

    function buildForm(units) {
        let option;
        let i;
        let unitno;
        let html;

        html = "" +
            "<br>" +
            "<button id='buttonUnits' type='button' onclick='loadForm()'>Reload units</button>" +
            "<button id='buttonExample' type='button' onclick='createExample()'>Example Sheet</button><br>" +
            "<br>" +
            "<b>Choose Unit(s):</b><br>" +
            "<select size='5' id='units' name='inputUnits' style='width:250px' required multiple>" +
            "</select><br>" +
            "<br>" +
            "" +
            "<b>Title</b><br>" +
            "<input id='inputName' name='inputName' type='text' value='Title' size='35' style='width:250px' required /><br>" +
            "<br>" +
            "" +
            "<b>Exercise 1</b><br>" +
            "<select name='inputExTypeArr' style='width:250px' required>" +
            "  <option value='A' selected>Type A: Translate the underlined words into Dutch.</option>" +
            "  <option value='B'>Type B: Complete the sentences with words from the box and translate into English.</option>" +
            "  <option value='C'>Type C: Complete the sentences with the translation of the Dutch words.</option>" +
            "  <option value='D'>Type D: Translate the words into Dutch.</option>" +
            "  <option value='E'>Type E: Translate the words into English.</option>" +
            "</select><br>" +
            "How many items?  <input name='inputItemsPerExArr' type='number' value=5 style='width:45px' required /><br><br>" +
            "" +
            "<b>Exercise 2</b><br>" +
            "<select name='inputExTypeArr' style='width:250px' required>" +
            "  <option value='A'>Type A: Translate the underlined words into Dutch.</option>" +
            "  <option value='B' selected>Type B: Complete the sentences with words from the box and translate into English.</option>" +
            "  <option value='C'>Type C: Complete the sentences with the translation of the Dutch words.</option>" +
            "  <option value='D'>Type D: Translate the words into Dutch.</option>" +
            "  <option value='E'>Type E: Translate the words into English.</option>" +
            "</select><br>" +
            "How many items?  <input name='inputItemsPerExArr' type='number' value=8 style='width:45px' required /><br><br>" +
            "" +
            "<b>Exercise 3</b><br>" +
            "<select name='inputExTypeArr' style='width:250px' required>" +
            "  <option value='A'>Type A: Translate the underlined words into Dutch.</option>" +
            "  <option value='B'>Type B: Complete the sentences with words from the box and translate into English.</option>" +
            "  <option value='C' selected>Type C: Complete the sentences with the translation of the Dutch words.</option>" +
            "  <option value='D'>Type D: Translate the words into Dutch.</option>" +
            "  <option value='E'>Type E: Translate the words into English.</option>" +
            "</select><br>" +
            "How many items?  <input name='inputItemsPerExArr' type='number' value=10 style='width:45px' required /><br><br>" +
            "" +
            "" +
            "<input id='submit' class='action' type='submit' value='Preview Quiz' />" +
            "<span id='msg' style='font-style:italic; font-size:small; color:black; margin-left:30px;'></span>" +
            "";


        document.getElementById("quizInput").innerHTML = html;

        for (i = 0; i < units.length; i++) {
            option = document.createElement("OPTION");
            unitno = String(units[i]).match(/\d+/)[0];

            option.setAttribute("id", units[i]);
            option.setAttribute("value", units[i]);
            option.setAttribute("label", units[i]);
            option.setAttribute("style", "text-align:left");
            option.setAttribute("onclick", "document.getElementById('inputName').value='SO Unit " + unitno + " versie " + getDateAndTime() + "'");

            document.getElementById("units").appendChild(option);
        }

        setDefaults();
        preventFormSubmit();
    }

    // helper function: prevents the form elements from submitting before the onclick handler can finish
    // (without it, when a form element has no action attribute specified, it will submit to a blank page)
    function preventFormSubmit() {
        let forms = document.querySelectorAll('form');
        for (let i = 0; i < forms.length; i++) {
            forms[i].addEventListener('submit', function(event) {
                event.preventDefault();
            });
        }
    }

    // helper function: set default form values, like default quiz title
    function setDefaults() {
        document.getElementById("inputName").value = 'SO ' + getDateAndTime();
    }


    /**
     * Handle form submit
     */
    function handleFormSubmit(formObject) { // Send input to function
        document.getElementById('submit').disabled = true;
        document.getElementById('msg').innerHTML = "Creating quiz...";
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(onSuccess)
            .button_previewQuiz_click(formObject);
    }

    function onFailure(error) {
        document.getElementById('submit').disabled = false;
        document.getElementById('msg').innerHTML =
            "ERROR: " + error.message + ". Please try again.";
    }

    function onSuccess() {
        document.getElementById('submit').disabled = false;
        document.getElementById('msg').innerHTML =
            "Success";
    }

    window.addEventListener('load', loadForm);
</script>